<script>
  // ──────────────────────────────────────────────────────────────
  //  CONFIG
  // ──────────────────────────────────────────────────────────────

  let GITHUB_TOKEN = localStorage.getItem('github_pat');
  if (!GITHUB_TOKEN) {
  GITHUB_TOKEN = prompt('GitHub PAT (repo scope):');
  if (GITHUB_TOKEN) localStorage.setItem('github_pat', GITHUB_TOKEN);
  }
  
  const GITHUB_OWNER   = 'tech-dreamer';                        // your GitHub username
  const GITHUB_REPO    = 'tech-dreamer.github.io';              // repo name (same as user‑site)
  const FILE_PATH      = 'forecasts.json';                     // file that will hold all forecasts
  const STORAGE_KEY_F  = 'knyc-daily-forecast';                // localStorage key
  const STORAGE_KEY_A  = 'knyc-actual-high-6hr';
  const CUTOFF_HOUR    = 12;   // 12 PM EST
  const REVEAL_HOUR    = 19;   // 7 PM EST
  const TODAY          = '2025-11-11';   // test date (will be dynamic later)
  const FALLBACK_HIGH  = 41;   // historical avg

  // ──────────────────────────────────────────────────────────────
  //  HELPERS
  // ──────────────────────────────────────────────────────────────
  const getESTHour = () => {
    const now = new Date();
    const utc = now.getUTCHours();
    return (utc - 5 + 24) % 24;               // EST = UTC‑5
  };
  const isCutoff = () => getESTHour() >= CUTOFF_HOUR;
  const isReveal = () => getESTHour() >= REVEAL_HOUR;

  // ──────────────────────────────────────────────────────────────
  //  GITHUB API: read / write forecasts.json
  // ──────────────────────────────────────────────────────────────
  const apiBase = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${FILE_PATH}`;

  async function readForecastFile() {
    try {
      const r = await fetch(apiBase, {
        headers: { Authorization: `token ${GITHUB_TOKEN}` }
      });
      if (!r.ok) throw new Error(r.status);
      const data = await r.json();
      const content = atob(data.content);          // base64 → plain text
      return JSON.parse(content);
    } catch (e) {
      console.warn('No forecasts.json yet (or error) → starting fresh', e);
      return {};                                   // empty object
    }
  }

  async function writeForecastFile(allForecasts) {
    const content = btoa(JSON.stringify(allForecasts, null, 2));
    const payload = { message: 'Add forecast', content };

    // Get current SHA (required for update)
    try {
      const get = await fetch(apiBase, {
        headers: { Authorization: `token ${GITHUB_TOKEN}` }
      });
      if (get.ok) {
        const info = await get.json();
        payload.sha = info.sha;
      }
    } catch (_) { /* first write – no SHA */ }

    const r = await fetch(apiBase, {
      method: 'PUT',
      headers: {
        Authorization: `token ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error(`GitHub write failed: ${r.status}`);
  }

  // ──────────────────────────────────────────────────────────────
  //  LOAD USER FORECAST (from localStorage + GitHub file)
  // ──────────────────────────────────────────────────────────────
  async function loadUserForecast() {
    const input = document.getElementById('knyc_high');

    // 1. Try temps.json (your old file)
    try {
      const r = await fetch('temps.json');
      if (r.ok) {
        const d = await r.json();
        if (d?.knyc_high) input.value = d.knyc_high;
      }
    } catch (_) {}

    // 2. localStorage (fallback)
    const saved = localStorage.getItem(STORAGE_KEY_F);
    if (saved) {
      const p = JSON.parse(saved);
      if (p.date === TODAY) input.value = p.forecast;
    }

    // 3. GitHub forecasts.json (authoritative)
    const all = await readForecastFile();
    if (all[TODAY]) input.value = all[TODAY];
  }

  // ──────────────────────────────────────────────────────────────
  //  SAVE USER FORECAST (localStorage + GitHub)
  // ──────────────────────────────────────────────────────────────
  async function saveUserForecast(forecast) {
    // 1. localStorage (instant)
    localStorage.setItem(STORAGE_KEY_F, JSON.stringify({ date: TODAY, forecast }));

    // 2. GitHub file
    const all = await readForecastFile();
    all[TODAY] = forecast;                     // simple key = date
    await writeForecastFile(all);
  }

  // ──────────────────────────────────────────────────────────────
  //  FETCH 6‑HR MAX HIGH (IEM obhistory)
  // ──────────────────────────────────────────────────────────────
  async function fetchActualHigh() {
    const cached = localStorage.getItem(STORAGE_KEY_A);
    if (cached) return parseInt(cached);

    const params = `date=${TODAY}&sortdir=desc&station=NYC&network=NY_ASOS&metar=0&madis=0`;
    const url = `https://mesonet.agron.iastate.edu/sites/obhistory.php?${params}`;

    try {
      const r = await fetch(url, { headers: { 'User-Agent': 'TempsApp/1.0' } });
      if (!r.ok) throw new Error('IEM fetch failed');
      const html = await r.text();

      const rows = [...html.matchAll(/<tr[^>]*>(.*?)<\/tr>/gs)].slice(1);
      let max = -Infinity;
      rows.forEach(row => {
        const cells = row[1].match(/<t[dh][^>]*>(.*?)<\/t[dh]>/gs) || [];
        if (cells.length > 7) {
          const txt = cells[7].replace(/<[^>]*>/g, '').trim();
          const val = parseFloat(txt.replace(/[^\d.-]/g, ''));
          if (!isNaN(val) && val > max) max = val;
        }
      });

      const high = max > -Infinity ? Math.round(max) : FALLBACK_HIGH;
      localStorage.setItem(STORAGE_KEY_A, high);
      return high;
    } catch (e) {
      console.error(e);
      const high = FALLBACK_HIGH;
      localStorage.setItem(STORAGE_KEY_A, high);
      return high;
    }
  }

  // ──────────────────────────────────────────────────────────────
  //  REVEAL LOGIC
  // ──────────────────────────────────────────────────────────────
  async function showReveal() {
    const revealDiv = document.getElementById('reveal');
    const all = await readForecastFile();
    const user = all[TODAY];

    if (!user) {
      revealDiv.innerHTML = '<p>No forecast saved for today.</p>';
      revealDiv.style.display = 'block';
      return;
    }

    const actual = await fetchActualHigh();
    const diff = Math.abs(user - actual);
    const emoji = diff === 0 ? 'First place medal' : diff <= 2 ? 'Sunglasses' : diff <= 5 ? 'Thumbs up' : 'Pinching hand';

    revealDiv.innerHTML = `
      <h2>Results – ${TODAY}</h2>
      <p>Your guess: <strong>${user}°F</strong></p>
      <p>Actual 6‑hr max: <strong>${actual}°F</strong></p>
      <p class="diff">${emoji} Off by ${diff}°</p>
    `;
    revealDiv.style.display = 'block';
  }

  // ──────────────────────────────────────────────────────────────
  //  UI HELPERS
  // ──────────────────────────────────────────────────────────────
  const showStatus = (msg, type) => {
    const s = document.getElementById('status');
    s.innerHTML = `<p class="${type}">${msg}</p>`;
    setTimeout(() => s.innerHTML = '', 5000);
  };

  // ──────────────────────────────────────────────────────────────
  //  MAIN – DOM READY
  // ──────────────────────────────────────────────────────────────
  document.addEventListener('DOMContentLoaded', () => {
    const form   = document.getElementById('tempsForm');
    const input  = document.getElementById('knyc_high');
    const btn    = document.getElementById('submitBtn');
    const status = document.getElementById('status');

    loadUserForecast();

    form.addEventListener('submit', async e => {
      e.preventDefault();

      if (isCutoff()) {
        showStatus('Submissions closed at 1 PM EST!', 'error');
        return;
      }

      const forecast = parseInt(input.value);
      if (!forecast || forecast < -25 || forecast > 125) {
        showStatus('Enter a whole number –25 … 125.', 'error');
        return;
      }

      try {
        await saveUserForecast(forecast);
        showStatus(`Forecast saved: ${forecast}°F`, 'success');
      } catch (err) {
        console.error(err);
        showStatus('Save failed – try again?', 'error');
      }
    });

    // LOCK UI after cutoff
    if (isCutoff()) {
      form.classList.add('locked');
      btn.disabled = true;
      status.innerHTML = '<p class="error">Closed – check back after 7 PM for results!</p>';
    }

    // REVEAL after 7 PM
    if (isReveal()) showReveal();
  });
</script>
