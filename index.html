<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Temps App</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {font-family:Arial,sans-serif;max-width:500px;margin:2rem auto;padding:1rem;background:#f9f9fb;}
    h1 {text-align:center;color:#2c3e50;}
    form {margin:2rem 0;text-align:center;}
    select, input {padding:0.8rem;font-size:1.6rem;border:2px solid #3498db;border-radius:8px;margin:0.5rem;}
    input {width:120px;text-align:center;}
    button {padding:0.8rem 1.4rem;background:#3498db;color:#fff;border:none;border-radius:8px;cursor:pointer;margin-left:1rem;}
    button:disabled {background:#ccc;cursor:not-allowed;opacity:0.6;}
    #status {text-align:center;margin:1rem 0;font-weight:bold;font-size:1.2rem;}
  </style>
  <script>
    const SUPABASE_URL = 'https://ckyqknlxmjqlkqnxhgef.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNreXFrbmx4bWpxbGtxbnhoZ2VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MDEwNjksImV4cCI6MjA4MDQ3NzA2OX0.KPzrKD3TW1CubAQhHyo5oJV0xQ_GLxBG96FSDfTN6p0';

    const { createClient } = supabase;
    const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let _cities = []; // doesnt really matter, but typically global variables are noted with _. constants are all caps

    // returns true if past noon in the selected city's time zone
    function isPastLocalNoon(cityId) {
      const timezones = {
        1: 'America/New_York',      // Eastern time
        2: 'America/Los_Angeles',   // Pacific time
        3: 'America/Chicago'        // Central time
      };

      const tz = timezones[cityId];
      if (!tz) return false;

      const now = new Date();
      const formatter = new Intl.DateTimeFormat('en-US', {
        timeZone: tz,
        hour: 'numeric',
        hour12: false
      });
      const hour = parseInt(formatter.format(now));
      return hour >= 12;
    }

    document.getElementById('tempsForm').addEventListener('submit', async e => {
      e.preventDefault();

      const cityId = document.getElementById('citySelect').value;
      const cityName = _cities[cityId].name;
      const guess  = document.getElementById('high').value.trim();

      if (!cityId || !guess) {
        document.getElementById('status').innerHTML = '<span style="color:red;">Pick a city and guess!</span>';
        return;
      }

      if (isPastLocalNoon(cityId)) {
        document.getElementById('status').innerHTML = `<span style="color:#e74c3c;">Too late! Cutoff was noon local time in ${cityName}.</span>`;
        return;
      }

      const today = new Date().toISOString().split('T')[0];

      const { error } = await client
        .from('daily_forecasts')
        .upsert({
          user_id: 1,
          city_id: Number(cityId),
          date: today,
          forecast: Number(guess)
        }, { onConflict: 'user_id,city_id,date' });

      if (error) {
        document.getElementById('status').innerHTML = `<span style="color:red;">${error.message}</span>`;
      } else {
        document.getElementById('status').innerHTML = `<span style="color:green;">Saved! ${guess}°F for ${cityName}</span>`;
      }
    });

    // disable form if past cutoff for selected city
    document.getElementById('citySelect').addEventListener('change', () => {
      const cityId = document.getElementById('citySelect').value;
      const cityName = _cities[cityId].name;
      const btn = document.getElementById('submitBtn');
      if (cityId && isPastLocalNoon(cityId)) {
        btn.disabled = true;
        document.getElementById('status').innerHTML = `<span style="color:#e74c3c;">Forecasting closed for ${cityName} (after noon local time)</span>`;
      } else {
        btn.disabled = false;
        document.getElementById('status').innerHTML = '';
      }
    });
    // this listener makes the page finish loading first. 90% of the pages will need it
    document.addEventListener("DOMContentLoaded", () => {
      cities = await client
        .from("cities")
        .select();
      cities.sort(c => c.name);
      const citySelect = document.getElementById("citySelect");
      citySelect.innerHTML = "";
      var placeholder = document.createElement("option");
      placeholder.setAttribute("selected");
      placeholder.setAttribute("disabled");
      placeholder.innerHTML = "Select city...";
      citySelect.appendChild(placeholder);
      cities.forEach(c => {
        var option = document.createElement("option");
        option.value =  c.id;
        option.innerHTML = c.name;
        citySelect.appendChild(option);
      });
      citySelect.value = cities[0].id;
    });
  </script>
</head>
<body>

  <h1>Daily High Forecast</h1>
  <p style="text-align:center;">Cutoff = 12 PM local time</p>

  <form id="tempsForm">
    <div>
      <label>
        City:<br>
        <select id="citySelect" required>
          <option value="" disabled selected>Loading cities...</option>
        </select>
      </label>
    </div>

    <div style="margin-top:1rem;">
      <label>
        Your Forecast (°F):<br>
        <input type="number" id="high" min="-25" max="125" step="1" required placeholder="0">
      </label>
    </div>

    <button type="submit" id="submitBtn">Confirm</button>
  </form>

  <div id="status"></div>
</body>
</html>
